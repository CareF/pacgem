#!/usr/bin/ruby

require 'tmpdir'
require 'fileutils'
require 'rubygems'
require 'shellwords'

def download_spec(name, version)
  version = version || Gem::Requirement.default

  all = Gem::Requirement.default
  dep = Gem::Dependency.new name, version

  puts "Download #{name} gem specification"

  specs_and_sources = Gem::SpecFetcher.fetcher.fetch dep, all
  specs_and_sources.sort_by { |spec,| spec.version }
  spec, source_uri = specs_and_sources.last

  raise "Could not find #{name} in any repository" if !spec

  puts "Downloaded #{spec.full_name}"

  path = Gem::RemoteFetcher.fetcher.download spec, source_uri
  FileUtils.mv path, "#{spec.full_name}.gem"

  spec
end

def get_depends(spec)
  depends = []
  spec.runtime_dependencies.each do |dep|
    dep.requirement.requirements.each do |comp, ver|
      depends << [dep.name, "#{comp}#{ver}"]
    end
  end
  depends
end

def generate_pkgbuild(spec, depends)
  name = spec.name
  depends = %w(ruby) + depends.map do |name,version|
    version.sub!(/^~>/, '>=')
    "ruby-#{name}#{version}"
  end

%{# Generated by pacgem
pkgname=ruby-#{name}
pkgver=#{spec.version}
pkgrel=1
pkgdesc=#{spec.summary.inspect}
arch=('i686' 'x86_64')
url=#{spec.homepage.inspect}
license=(#{spec.license && spec.license.inspect})
depends=(#{depends.map(&:inspect).join(' ')})
makedepends=('rubygems')
source=(http://rubygems.org/gems/#{name}-$pkgver.gem)
noextract=(#{name}-$pkgver.gem)
build() {
  cd $srcdir
  gem install --no-ri --no-rdoc --ignore-dependencies -i "$pkgdir#{Gem.default_dir}" #{name}-$pkgver.gem
  rm -f "$pkgdir#{Gem.default_dir}/cache/#{name}-$pkgver.gem"
  rmdir "$pkgdir#{Gem.default_dir}/cache" "$pkgdir#{Gem.default_dir}/doc" || true
}
}
end

def install_package(name, version, explicit = true)
  spec = download_spec(name, version)
  name = "ruby-#{spec.name}"
  full_name = "ruby-#{spec.full_name}"
  installed = `pacman -Q #{name.shellescape} 2>/dev/null`.split(/\s+/)
  if installed[1] =~ /^#{spec.version}\-\d+$/
    puts "#{full_name} is already installed"
  else
    depends = get_depends(spec)
    depends.each {|n, v| install_package(n, v, false) }
    File.open('PKGBUILD', 'w') {|f| f.write generate_pkgbuild(spec, depends) }
    `makepkg --skipinteg`
    pkgfile = Dir["#{full_name}-*.pkg.*"].first
    raise "makepkg #{full_name} failed" if !pkgfile
    puts "Installing #{pkgfile} with pacman"
    `sudo pacman #{explicit ? '--asexplicit' : '--asdeps'} -U #{pkgfile.shellescape}`
  end
end

if $0 == __FILE__
  if ARGV.length < 1
    puts "Usage: #{$0} gem-name [gem-version]"
    exit
  end

  begin
    Dir.mktmpdir('pacgem-') do |tmp|
      Dir.chdir(tmp) do
        install_package(ARGV[0], ARGV[1])
      end
    end
  rescue => ex
    puts ex.message
    exit 1
  end
end
